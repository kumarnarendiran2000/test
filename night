export async function waitForPageLoadWithRefresh(timeout = 50000, refreshTimeout = 10000) {
    try {
        // Wait for the page to fully load within the given timeout
        await browser.waitUntil(
            async () => (await browser.execute(() => document.readyState)) === 'complete',
            { timeout, interval: 500 }
        );
    } catch (error) {
        console.warn(`⚠️ Page did not load in ${timeout / 1000} seconds. Refreshing...`);
        
        // Refresh the page
        await browser.refresh();

        // Wait again after refresh
        await browser.waitUntil(
            async () => (await browser.execute(() => document.readyState)) === 'complete',
            { timeout: refreshTimeout, interval: 500 }
        );
    }
}

async openDashboard(url: string) {
    const handles = await browser.getWindowHandles();

    if (handles.length === 1) {
        // If only one tab exists, navigate to the URL instead of opening a new one
        console.warn("Only one tab exists, navigating instead of opening a new tab...");
        await browser.url(url);
    } else {
        // If multiple tabs exist, check if the URL is already open
        const currentUrl = await browser.getUrl();
        if (currentUrl !== url) {
            console.warn("Opening a new tab since the URL is different...");
            await browser.newWindow(url, { type: 'tab' });
        } else {
            console.warn("The correct URL is already open, no new tab needed.");
        }
    }

    // Ensure the page is fully loaded
    await waitForPageLoadWithRefresh();
}

class EmberDashboardPage {
    hasOpenedNewTab = false; // Track whether a new tab was opened

    async openDashboard(url: string) {
        const handles = await browser.getWindowHandles();

        if (!this.hasOpenedNewTab) {
            // First time: Load in the same tab
            console.warn("First loop: Navigating in the same tab...");
            await browser.url(url);
            this.hasOpenedNewTab = true; // Mark that the first round is done
        } else {
            // Second time and beyond: Open in a new tab only once
            console.warn("Second loop onward: Opening a new tab...");
            await browser.newWindow(url, { type: 'tab' });
        }

        // Ensure the page is fully loaded
        await waitForPageLoadWithRefresh();
    }
}