import { browser } from '@wdio/globals';

/**
 * Authenticates the browser session by setting cookies.
 * @param standardlifeId Standard Life ID of the test user.
 */
export async function authenticate(standardlifeId: string) {
  await browser.setCookies([
    { name: 'ck', value: standardlifeId, path: '/', domain: 'localhost' },
  ]);
}

export const defaultUser = {
  standardlifeId: '970205143728',
};

export const testPacks = [
  {
    standardlifeId: '990008710739',
    welcomeName: 'TestUser',
    planValue: 46670,
    investmentGrowth: 20375,
  },
  {
    standardlifeId: '952000708475',
    welcomeName: 'Tony',
    planValue: 10000000,
    investmentGrowth: 90000000,
  },
];

import { browser, expect } from '@wdio/globals';
import { authenticate } from '../utils/authenticate';
import { defaultUser, testPacks } from '../test-config';

describe('Login and Carry Cookie to Localhost', () => {
  before(async () => {
    await browser.setWindowRect(1920, 0, 1200, 800);
    await browser.maximizeWindow();
  });

  it('should login, keep the session alive, and load localhost with the cookie', async () => {
    await authenticate(defaultUser.standardlifeId);

    await browser.newWindow('http://localhost:8081/', { type: 'tab' });

    await browser.pause(5000);

    const totalValueElement = $('//span[contains(text(), "£")]');
    await expect(totalValueElement).toBeDisplayed();

    const totalValueFromEmber = await totalValueElement.getText();
    console.log(`Total Value: ${totalValueFromEmber}`);
  });
});

describe('Validate Dynamic Data Across Users', () => {
  testPacks.forEach((testPack) => {
    describe(`CK: ${testPack.standardlifeId}`, () => {
      it(`should authenticate and validate values for ${testPack.welcomeName}`, async () => {
        await authenticate(testPack.standardlifeId);
        await browser.newWindow('http://localhost:8081/', { type: 'tab' });

        const totalValueElement = $('//span[contains(text(), "£")]');
        await expect(totalValueElement).toBeDisplayed();

        const totalValueFromEmber = await totalValueElement.getText();
        console.log(`Total Value for ${testPack.welcomeName}: ${totalValueFromEmber}`);

        expect(totalValueFromEmber).toEqual(testPack.planValue.toLocaleString());
      });
    });
  });
});


import { handle } from 'hono/aws-lambda';
import { HTTPException } from 'hono/http-exception';
import type { JSONObject } from 'hono/utils/types';
import { factory } from './hono-factory';
import { authenticationAdapter } from './middlewares/authentication-adapter';
import { delay } from './middlewares/delay';
import { v4 as uuidv4 } from 'uuid';

export const app = factory.createApp();

app.use('/secure/*', authenticationAdapter);
app.use('/secure/*', delay);

// Health check route
app.get('/healthcheck', async (c) => {
  return c.text('Mock SLAL legacy API server up and running');
});

// Mock CSRF Token API
app.get('/secure/customer-platform/rest/api/csrftoken', async (c) => {
  const csrfToken = uuidv4(); // Generate a unique token
  return c.json({ csrfToken });
});

// Mock Logout API
app.get('/secure/customer-platform/logout', async (c) => {
  const csrfToken = c.req.query('CSRF_TOKEN'); // Retrieve the token from query params

  if (!csrfToken) {
    throw new HTTPException(400, { message: 'CSRF token is required' });
  }

  return c.json({ message: 'Logout successful', csrfToken });
});

export default app;
